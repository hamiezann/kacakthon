<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Insurance DApp</title>
    <!-- ethers.js from CDN -->
    <script type="module" src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.min.js"></script>
    <link rel="stylesheet" href="/styles/index.css">
</head>
<body>
    <h1>Car Insurance DApp</h1>
    
    <!-- Display contract address -->
    <div id="contractAddress"></div>

    <!-- Section for displaying available policies -->
    <div>
        <h3>Available Policies</h3>
        <div id="displayedPolicies"></div>
    </div>

    <!-- Form for selecting policy and entering NCD -->
    <div>
        <h3>Select a Policy</h3>
        <form id="insuranceForm">
            <label for="policySelect">Choose a Policy:</label>
            <select id="policySelect" name="policySelect"></select><br><br>

            <label for="ncdInput">Enter your NCD (No Claims Discount):</label>
            <input type="number" id="ncdInput" name="ncdInput" min="0" placeholder="Enter NCD value"><br><br>

            <button type="button" id="registerPolicyBtn">Register Policy</button>
        </form>

        <div id="message"></div>
    </div>

    <script type="module">
        import { ethers } from "https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.min.js";

        let signer;
        let carInsuranceContract;

        const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3"; // Contract address

        // Dummy data for policies (5 sample policies with real-world-like data)
        const dummyPolicies = [
            { id: 0, name: "Basic Coverage", description: "Covers minor accidents and third-party liabilities.", premiumAmount: "0.05", coverage: "Up to $10,000" },
            { id: 1, name: "Standard Coverage", description: "Covers accidents, theft, and third-party liabilities.", premiumAmount: "0.10", coverage: "Up to $50,000" },
            { id: 2, name: "Comprehensive Coverage", description: "Full coverage for accidents, theft, fire, and natural disasters.", premiumAmount: "0.20", coverage: "Up to $100,000" },
            { id: 3, name: "Premium Coverage", description: "Includes comprehensive coverage with added benefits.", premiumAmount: "0.30", coverage: "Up to $200,000" },
            { id: 4, name: "Elite Coverage", description: "Top-tier coverage for high-end vehicles and full protection.", premiumAmount: "0.50", coverage: "Unlimited" }
        ];

        // Function to load ABI from local JSON file
        async function loadABI() {
            try {
                const response = await fetch('../artifacts/contracts/CarInsurance.sol/CarInsurance.json'); // Ensure correct path
                if (!response.ok) {
                    throw new Error(`Error loading ABI: ${response.statusText}`);
                }
                const contractData = await response.json();
                return contractData.abi; // Access the `abi` field
            } catch (error) {
                console.error("Failed to load ABI:", error);
                document.getElementById("message").innerText = "Error loading ABI. Check console for details.";
                throw error;
            }
        }

        // Function to display dummy policies on the page
        function displayPolicies() {
            let policyDisplayHTML = '';

            dummyPolicies.forEach(policy => {
                policyDisplayHTML += `
                    <div class="policy">
                        <h4>${policy.name}</h4>
                        <p>${policy.description}</p>
                        <p>Premium: ${policy.premiumAmount} ETH</p>
                        <p>Coverage: ${policy.coverage}</p>
                    </div>
                    <hr>
                `;
            });

            // Display policy data in the "displayedPolicies" section
            document.getElementById("displayedPolicies").innerHTML = policyDisplayHTML;

            // Load policies into the dropdown
            let policyOptionsHTML = '';
            dummyPolicies.forEach(policy => {
                policyOptionsHTML += `<option value="${policy.id}">${policy.name} - ${policy.premiumAmount} ETH</option>`;
            });
            document.getElementById("policySelect").innerHTML = policyOptionsHTML;
        }

        // On page load, connect to the contract and display policies
        async function init() {
            if (typeof window.ethereum !== 'undefined') {
                await ethereum.request({ method: 'eth_requestAccounts' });

                // Initialize provider and signer
                const provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                // Load the ABI dynamically
                const contractABI = await loadABI();

                // Initialize contract with ABI and contract address
                carInsuranceContract = new ethers.Contract(contractAddress, contractABI, signer);

                // Display the contract address on the page
                document.getElementById("contractAddress").innerText = `Contract Address: ${contractAddress}`;

                // Display dummy policies
                displayPolicies();
            } else {
                alert("Please install MetaMask!");
            }
        }

        // Register user for a selected policy
        document.getElementById("registerPolicyBtn").addEventListener('click', async () => {
            const selectedPolicyId = document.getElementById("policySelect").value;  // Get selected policy
            const ncdValue = document.getElementById("ncdInput").value;  // Get entered NCD value

            // Ensure that both policy and NCD are selected/entered
            if (!selectedPolicyId || ncdValue === "") {
                document.getElementById("message").innerText = "Please select a policy and enter your NCD.";
                return;
            }

            try {
                // Call registerUser function in smart contract with the selected policy and NCD
                const tx = await carInsuranceContract.registerUser(selectedPolicyId, ncdValue, {
                    value: ethers.parseEther("0.01") // Adjust payment amount as necessary
                });

                await tx.wait();  // Wait for the transaction to be confirmed
                document.getElementById("message").innerText = "Successfully registered!";
            } catch (error) {
                console.error("Registration Error:", error);
                document.getElementById("message").innerText = "Error: " + error.message;
            }
        });

        // Initialize the app on page load
        window.addEventListener('load', init);
    </script>
</body>
</html>
